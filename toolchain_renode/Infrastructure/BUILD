load(
    "@rules_dotnet//dotnet:defs.bzl",
    "csharp_library",
)

package(default_visibility = ["//visibility:public"])


csharp_library(
    name = "cores-ppc64",
    srcs = ["@renode_sources//:cores-ppc64"],
    internals_visible_to = ["lib_cores-ppc64"],
    target_frameworks = ["net6.0"],
    targeting_packs = [
        "@rules_dotnet_nuget_packages//microsoft.netcore.app.ref",
    ],
    deps = [
        "//toolchain_renode/Infrastructure/Emulator/Main:Emulator",
        "//toolchain_renode/Infrastructure/Emulator/Extensions:Extensions",
        "//toolchain_renode/Infrastructure/Emulator/Peripherals:Peripherals",
        "//toolchain_renode/Migrant:Migrant",
        "//toolchain_renode/ELFSharp:ELFSharp",
        "//toolchain_renode/PacketDotNet:PacketDotNet",
        "//toolchain_renode/CxxDemangler:CxxDemangler",
        "//toolchain_renode/AntShell:AntShell",
        "//toolchain_renode/Xwt:Xwt",
        "//toolchain_renode/BigGustave:BigGustave",
        "//toolchain_renode/Xwt:XwtGtk",
        "//toolchain_renode/termsharp:TermSharp",
        "//toolchain_renode/resources:LuceneNet",
        "//toolchain_renode/resources:IronPython",
        "//toolchain_renode/resources:IronPythonStdLib",
        "//toolchain_renode/resources:IronPythonModules",
        "//toolchain_renode/resources:MicrosoftScripting",
        "//toolchain_renode/resources:LZ4",
        "//toolchain_renode/resources:MonoLinqExpressions",
        "//toolchain_renode/resources:MonoTextTemplating",
        "//toolchain_renode/resources:Dynamitey",
        "//toolchain_renode/resources:Nini",
        "@nuget_packages//system.drawing.common",
        "@nuget_packages//gtksharp",
        "@nuget_packages//atksharp",
        "@nuget_packages//glibsharp",
        "@nuget_packages//cairosharp",
        "@nuget_packages//gdksharp",
        "@nuget_packages//giosharp",
        "@nuget_packages//pangosharp",
        "@nuget_packages//mono.posix.netstandard",
        "@nuget_packages//microsoft.codeanalysis.csharp",
        "@nuget_packages//microsoft.codeanalysis.visualbasic",
        "@nuget_packages//microsoft.codeanalysis.common",
        "@nuget_packages//microsoft.codeanalysis.analyzers",
        "@nuget_packages//system.codedom",
        "@nuget_packages//system.configuration.configurationmanager",
        "@nuget_packages//mono.cecil",
    ],
    defines = ["NET"],
    allow_unsafe_blocks = True,
    visibility = ["//visibility:public"],
)

csharp_library(
    name = "cores-riscv",
    srcs = ["@renode_sources//:cores-riscv"],
    internals_visible_to = ["lib_cores-riscv"],
    target_frameworks = ["net6.0"],
    targeting_packs = [
        "@rules_dotnet_nuget_packages//microsoft.netcore.app.ref",
    ],
    deps = [
        "//toolchain_renode/Infrastructure/Emulator/Main:Emulator",
        "//toolchain_renode/Infrastructure/Emulator/Extensions:Extensions",
        "//toolchain_renode/Infrastructure/Emulator/Peripherals:Peripherals",
        "//toolchain_renode/Migrant:Migrant",
        "//toolchain_renode/ELFSharp:ELFSharp",
        "//toolchain_renode/PacketDotNet:PacketDotNet",
        "//toolchain_renode/CxxDemangler:CxxDemangler",
        "//toolchain_renode/AntShell:AntShell",
        "//toolchain_renode/Xwt:Xwt",
        "//toolchain_renode/BigGustave:BigGustave",
        "//toolchain_renode/Xwt:XwtGtk",
        "//toolchain_renode/termsharp:TermSharp",
        "//toolchain_renode/resources:LuceneNet",
        "//toolchain_renode/resources:IronPython",
        "//toolchain_renode/resources:IronPythonStdLib",
        "//toolchain_renode/resources:IronPythonModules",
        "//toolchain_renode/resources:MicrosoftScripting",
        "//toolchain_renode/resources:LZ4",
        "//toolchain_renode/resources:MonoLinqExpressions",
        "//toolchain_renode/resources:MonoTextTemplating",
        "//toolchain_renode/resources:Dynamitey",
        "//toolchain_renode/resources:Nini",
        "@nuget_packages//system.drawing.common",
        "@nuget_packages//gtksharp",
        "@nuget_packages//atksharp",
        "@nuget_packages//glibsharp",
        "@nuget_packages//cairosharp",
        "@nuget_packages//gdksharp",
        "@nuget_packages//giosharp",
        "@nuget_packages//pangosharp",
        "@nuget_packages//mono.posix.netstandard",
        "@nuget_packages//microsoft.codeanalysis.csharp",
        "@nuget_packages//microsoft.codeanalysis.visualbasic",
        "@nuget_packages//microsoft.codeanalysis.common",
        "@nuget_packages//microsoft.codeanalysis.analyzers",
        "@nuget_packages//system.codedom",
        "@nuget_packages//system.configuration.configurationmanager",
        "@nuget_packages//mono.cecil",
    ],
    defines = ["NET"],
    allow_unsafe_blocks = True,
    visibility = ["//visibility:public"],
)

csharp_library(
    name = "cores-riscv64",
    srcs = ["@renode_sources//:cores-riscv64"],
    internals_visible_to = ["lib_cores-riscv64"],
    target_frameworks = ["net6.0"],
    targeting_packs = [
        "@rules_dotnet_nuget_packages//microsoft.netcore.app.ref",
    ],
    deps = [
        "//toolchain_renode/Infrastructure/Emulator/Main:Emulator",
        "//toolchain_renode/Infrastructure/Emulator/Extensions:Extensions",
        "//toolchain_renode/Infrastructure/Emulator/Peripherals:Peripherals",
        "//:cores-riscv",
        "//toolchain_renode/Migrant:Migrant",
        "//toolchain_renode/ELFSharp:ELFSharp",
        "//toolchain_renode/PacketDotNet:PacketDotNet",
        "//toolchain_renode/CxxDemangler:CxxDemangler",
        "//toolchain_renode/AntShell:AntShell",
        "//toolchain_renode/Xwt:Xwt",
        "//toolchain_renode/BigGustave:BigGustave",
        "//toolchain_renode/Xwt:XwtGtk",
        "//toolchain_renode/termsharp:TermSharp",
        "//toolchain_renode/resources:LuceneNet",
        "//toolchain_renode/resources:IronPython",
        "//toolchain_renode/resources:IronPythonStdLib",
        "//toolchain_renode/resources:IronPythonModules",
        "//toolchain_renode/resources:MicrosoftScripting",
        "//toolchain_renode/resources:LZ4",
        "//toolchain_renode/resources:MonoLinqExpressions",
        "//toolchain_renode/resources:MonoTextTemplating",
        "//toolchain_renode/resources:Dynamitey",
        "//toolchain_renode/resources:Nini",
        "@nuget_packages//system.drawing.common",
        "@nuget_packages//gtksharp",
        "@nuget_packages//atksharp",
        "@nuget_packages//glibsharp",
        "@nuget_packages//cairosharp",
        "@nuget_packages//gdksharp",
        "@nuget_packages//giosharp",
        "@nuget_packages//pangosharp",
        "@nuget_packages//mono.posix.netstandard",
        "@nuget_packages//microsoft.codeanalysis.csharp",
        "@nuget_packages//microsoft.codeanalysis.visualbasic",
        "@nuget_packages//microsoft.codeanalysis.common",
        "@nuget_packages//microsoft.codeanalysis.analyzers",
        "@nuget_packages//system.codedom",
        "@nuget_packages//system.configuration.configurationmanager",
        "@nuget_packages//mono.cecil",
    ],
    defines = ["NET"],
    allow_unsafe_blocks = True,
    visibility = ["//visibility:public"],
)

csharp_library(
    name = "cores-sparc",
    srcs = ["@renode_sources//:cores-sparc"],
    internals_visible_to = ["lib_cores-sparc"],
    target_frameworks = ["net6.0"],
    targeting_packs = [
        "@rules_dotnet_nuget_packages//microsoft.netcore.app.ref",
    ],
    deps = [
        "//toolchain_renode/Infrastructure/Emulator/Main:Emulator",
        "//toolchain_renode/Infrastructure/Emulator/Extensions:Extensions",
        "//toolchain_renode/Infrastructure/Emulator/Peripherals:Peripherals",
        "//toolchain_renode/Migrant:Migrant",
        "//toolchain_renode/ELFSharp:ELFSharp",
        "//toolchain_renode/PacketDotNet:PacketDotNet",
        "//toolchain_renode/CxxDemangler:CxxDemangler",
        "//toolchain_renode/AntShell:AntShell",
        "//toolchain_renode/Xwt:Xwt",
        "//toolchain_renode/BigGustave:BigGustave",
        "//toolchain_renode/Xwt:XwtGtk",
        "//toolchain_renode/termsharp:TermSharp",
        "//toolchain_renode/resources:LuceneNet",
        "//toolchain_renode/resources:IronPython",
        "//toolchain_renode/resources:IronPythonStdLib",
        "//toolchain_renode/resources:IronPythonModules",
        "//toolchain_renode/resources:MicrosoftScripting",
        "//toolchain_renode/resources:LZ4",
        "//toolchain_renode/resources:MonoLinqExpressions",
        "//toolchain_renode/resources:MonoTextTemplating",
        "//toolchain_renode/resources:Dynamitey",
        "//toolchain_renode/resources:Nini",
        "@nuget_packages//system.drawing.common",
        "@nuget_packages//gtksharp",
        "@nuget_packages//atksharp",
        "@nuget_packages//glibsharp",
        "@nuget_packages//cairosharp",
        "@nuget_packages//gdksharp",
        "@nuget_packages//giosharp",
        "@nuget_packages//pangosharp",
        "@nuget_packages//mono.posix.netstandard",
        "@nuget_packages//microsoft.codeanalysis.csharp",
        "@nuget_packages//microsoft.codeanalysis.visualbasic",
        "@nuget_packages//microsoft.codeanalysis.common",
        "@nuget_packages//microsoft.codeanalysis.analyzers",
        "@nuget_packages//system.codedom",
        "@nuget_packages//system.configuration.configurationmanager",
        "@nuget_packages//mono.cecil",
    ],
    defines = ["NET"],
    allow_unsafe_blocks = True,
    visibility = ["//visibility:public"],
)

csharp_library(
    name = "cores-xtensa",
    srcs = ["@renode_sources//:cores-xtensa"],
    internals_visible_to = ["lib_cores-xtensa"],
    target_frameworks = ["net6.0"],
    targeting_packs = [
        "@rules_dotnet_nuget_packages//microsoft.netcore.app.ref",
    ],
    deps = [
        "//toolchain_renode/Infrastructure/Emulator/Main:Emulator",
        "//toolchain_renode/Infrastructure/Emulator/Extensions:Extensions",
        "//toolchain_renode/Infrastructure/Emulator/Peripherals:Peripherals",
        "//toolchain_renode/Migrant:Migrant",
        "//toolchain_renode/ELFSharp:ELFSharp",
        "//toolchain_renode/PacketDotNet:PacketDotNet",
        "//toolchain_renode/CxxDemangler:CxxDemangler",
        "//toolchain_renode/AntShell:AntShell",
        "//toolchain_renode/Xwt:Xwt",
        "//toolchain_renode/BigGustave:BigGustave",
        "//toolchain_renode/Xwt:XwtGtk",
        "//toolchain_renode/termsharp:TermSharp",
        "//toolchain_renode/resources:LuceneNet",
        "//toolchain_renode/resources:IronPython",
        "//toolchain_renode/resources:IronPythonStdLib",
        "//toolchain_renode/resources:IronPythonModules",
        "//toolchain_renode/resources:MicrosoftScripting",
        "//toolchain_renode/resources:LZ4",
        "//toolchain_renode/resources:MonoLinqExpressions",
        "//toolchain_renode/resources:MonoTextTemplating",
        "//toolchain_renode/resources:Dynamitey",
        "//toolchain_renode/resources:Nini",
        "@nuget_packages//system.drawing.common",
        "@nuget_packages//gtksharp",
        "@nuget_packages//atksharp",
        "@nuget_packages//glibsharp",
        "@nuget_packages//cairosharp",
        "@nuget_packages//gdksharp",
        "@nuget_packages//giosharp",
        "@nuget_packages//pangosharp",
        "@nuget_packages//mono.posix.netstandard",
        "@nuget_packages//microsoft.codeanalysis.csharp",
        "@nuget_packages//microsoft.codeanalysis.visualbasic",
        "@nuget_packages//microsoft.codeanalysis.common",
        "@nuget_packages//microsoft.codeanalysis.analyzers",
        "@nuget_packages//system.codedom",
        "@nuget_packages//system.configuration.configurationmanager",
        "@nuget_packages//mono.cecil",
    ],
    defines = ["NET"],
    allow_unsafe_blocks = True,
    visibility = ["//visibility:public"],
)



cc_library(
    name = "tcg",
    srcs = [
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-runtime.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/optimize.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/additional.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/host-utils.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-op-gvec.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-op-vec.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-runtime-gvec.c",
    ],
    hdrs = [
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-runtime.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/additional.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/host-utils.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-op-gvec.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/bswap.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-op.h",
        #TODO: make target as a variable
        # there is also arm
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/i386/tcg-target.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/i386/tcg-target.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-memop.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-opc.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/tcg-gvec-desc.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/include/bit_helper.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/include/infrastructure.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/include/osdep.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/include/callbacks.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/include/def-helper.h",
    ],
    defines = [
        "HOST_LONG_BITS=64",
        "TARGET_INSN_START_EXTRA_WORDS=1",
        "TARGET_LONG_BITS=32",
    ],
    copts = [
        "-fomit-frame-pointer",
        "-O3",
        "-fPIC",
    ],
    includes = [
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg",
        #TODO: make target as a variable
        # there is also arm
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/i386",
           "src/Infrastructure/src/Emulator/Cores/tlib/include",
    ],
)

filegroup(
    name = "translate_sources",
    srcs = glob([
           "src/Infrastructure/src/Emulator/Cores/tlib/*.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/arch/*.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/external/*.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/fpu/*.c",
           "src/Infrastructure/src/Emulator/Cores/tlib/arch/arm/*.c",
           "src/Infrastructure/src/Emulator/Cores/renode/*.c",
           "src/Infrastructure/src/Emulator/Cores/renode/arch/arm/*.c",
    ]),
)

filegroup(
    name = "translate_headers",
    srcs = glob([
           "src/Infrastructure/src/Emulator/Cores/tlib/*.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/arch/*.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/external/*.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/fpu/*.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/arch/arm/*.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/include/*.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/*.h",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/arm/*.h",
           "src/Infrastructure/src/Emulator/Cores/renode/*.h",
           "src/Infrastructure/src/Emulator/Cores/renode/include/*.h",
           "src/Infrastructure/src/Emulator/Cores/renode/arm/*.h",
    ]),
)

#TODO: csharp_library resources doesn't allow to rename libraries
# we are creating here binary, but it is in fact library
# remove this hack, when csharp_library resources will allow to rename resources
cc_binary(
    name = "translate-arm-m-le.so",
    linkshared = True,
    srcs = [
        "//:translate_sources",
        "//:translate_headers",
    ],
    #hdrs = [
    #],
    deps = [
        "//:tcg",
    ],
    defines = [
        "HOST_BITS_64",
        "HOST_I386=1",
        "HOST_LONG_BITS=64",
        "TARGET_ARM=1",
        "TARGET_INSN_START_EXTRA_WORDS=1",
        "TARGET_INT_ALIGNMENT=4",
        "TARGET_LLONG_ALIGNMENT=4",
        "TARGET_LONG_ALIGNMENT=4",
        "TARGET_LONG_BITS=32",
        "TARGET_SHORT_ALIGNMENT=2",
        "TCG_TARGET_I386",
        "TARGET_PROTO_ARM_M=1",
    ],
    copts = [
        "-fomit-frame-pointer",
        "-O3",
        "-fPIC",
        "-Wall",
        "-Wextra",
        "-Werror",
        "-Wno-unused-parameter",
        "-Wno-sign-compare",
    ],
    includes = [
           "src/Infrastructure/src/Emulator/Cores/tlib/arch/arm",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg/i386",
           "src/Infrastructure/src/Emulator/Cores/tlib/include",
           "src/Infrastructure/src/Emulator/Cores/tlib/fpu",
           "src/Infrastructure/src/Emulator/Cores/tlib/tcg",
           "src/Infrastructure/src/Emulator/Cores/renode/include",
    ],
    linkopts = [
        "-Wl,--wrap=memcpy",
        "-zdefs",
        "-lpthread",
    ],
)
