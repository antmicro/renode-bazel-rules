load("@//toolchain_renode:toolchain.bzl", "renode_toolchain")
load("@//toolchain_renode:copy.bzl", "copy")
package(default_visibility = ["//visibility:public"])

toolchain_type(
    name = "toolchain_type",
    visibility = ["//visibility:public"],
)

copy(
    name = "copy_styles_robot",
    src = "//toolchain_renode/resources:robot-style",
    out = "lib/resources/styles/robot.css",
)

# toolchain_impl gathers information about the Renode toolchain.
# See the RenodeToolchain provider.
renode_toolchain(
    name = "toolchain_impl",
    runtime = [":runtime"],
)

# This target should be registered by
# calling register_toolchains in a WORKSPACE file.
toolchain(
    name = "toolchain",
    toolchain = ":toolchain_impl",
    toolchain_type = "//:toolchain_type",
)

load(
    "@rules_dotnet//dotnet:defs.bzl",
    "csharp_library",
    "csharp_binary",
    "publish_binary",
)

csharp_library(
    name = "VerilatorPlugin",
    srcs = ["@toolchain_renode//:VerilatorPlugin"],
    internals_visible_to = ["lib_verilatorplugin"],
    target_frameworks = ["net6.0"],
    targeting_packs = [
        "@rules_dotnet_nuget_packages//microsoft.netcore.app.ref",
    ],
    deps = [
        "@RenodeInfrastructure//:Emulator",
        "@RenodeInfrastructure//:Extensions",
        "@RenodeInfrastructure//:Renode-peripherals",
        "@RenodeInfrastructure//:cores-riscv",
        "@Migrant//:Migrant",
        "@ELFSharp//:ELFSharp",
        "@PacketDotNet//:PacketDotNet",
        "@CxxDemangler//:CxxDemangler",
        "@AntShell//:AntShell",
        "@Xwt//:Xwt",
        "@BigGustave//:BigGustave",
        "@Xwt//:XwtGtk",
        "@termsharp//:TermSharp",
        "//toolchain_renode/resources:Lucene",
        "//toolchain_renode/resources:IronPython",
        "//toolchain_renode/resources:IronPythonStdLib",
        "//toolchain_renode/resources:IronPythonModules",
        "//toolchain_renode/resources:MicrosoftScripting",
        "//toolchain_renode/resources:MonoLinqExpressions",
        "//toolchain_renode/resources:MonoTextTemplating",
        "@nuget_packages//:dynamitey",
        "@nuget_packages//:system.drawing.common",
        "@nuget_packages//:gtksharp",
        "@nuget_packages//:atksharp",
        "@nuget_packages//:glibsharp",
        "@nuget_packages//:cairosharp",
        "@nuget_packages//:gdksharp",
        "@nuget_packages//:giosharp",
        "@nuget_packages//:pangosharp",
        "@nuget_packages//:mono.posix.netstandard",
        "@nuget_packages//:microsoft.codeanalysis.csharp",
        "@nuget_packages//:microsoft.codeanalysis.visualbasic",
        "@nuget_packages//:microsoft.codeanalysis.common",
        "@nuget_packages//:microsoft.codeanalysis.analyzers",
        "@nuget_packages//:system.codedom",
        "@nuget_packages//:system.configuration.configurationmanager",
        "@nuget_packages//:mono.cecil",
    ],
    defines = ["NET"],
    allow_unsafe_blocks = True,
)

csharp_library(
    name = "WiresharkPlugin",
    srcs = [
     "src/Plugins/WiresharkPlugin/BLESniffer.cs",
     "src/Plugins/WiresharkPlugin/INetworkLogExtensions.cs",
     "src/Plugins/WiresharkPlugin/LinkLayer.cs",
     "src/Plugins/WiresharkPlugin/Wireshark.cs",
     "src/Plugins/WiresharkPlugin/WiresharkPlugin.cs",
     "src/Plugins/WiresharkPlugin/WiresharkSender.cs",
    ],
    internals_visible_to = ["lib_wiresharkplugin"],
    target_frameworks = ["net6.0"],
    targeting_packs = [
        "@rules_dotnet_nuget_packages//microsoft.netcore.app.ref",
    ],
    deps = [
        "@RenodeInfrastructure//:Emulator",
        "@RenodeInfrastructure//:Extensions",
        "@Migrant//:Migrant",
        "@ELFSharp//:ELFSharp",
        "@PacketDotNet//:PacketDotNet",
        "@CxxDemangler//:CxxDemangler",
        "@AntShell//:AntShell",
        "@Xwt//:Xwt",
        "@BigGustave//:BigGustave",
        "@Xwt//:XwtGtk",
        "@termsharp//:TermSharp",
        "//toolchain_renode/resources:Lucene",
        "//toolchain_renode/resources:IronPython",
        "//toolchain_renode/resources:IronPythonStdLib",
        "//toolchain_renode/resources:IronPythonModules",
        "//toolchain_renode/resources:MicrosoftScripting",
        "//toolchain_renode/resources:MonoLinqExpressions",
        "//toolchain_renode/resources:MonoTextTemplating",
        "@nuget_packages//:dynamitey",
        "@nuget_packages//:system.drawing.common",
        "@nuget_packages//:gtksharp",
        "@nuget_packages//:atksharp",
        "@nuget_packages//:glibsharp",
        "@nuget_packages//:cairosharp",
        "@nuget_packages//:gdksharp",
        "@nuget_packages//:giosharp",
        "@nuget_packages//:pangosharp",
        "@nuget_packages//:mono.posix.netstandard",
        "@nuget_packages//:microsoft.codeanalysis.csharp",
        "@nuget_packages//:microsoft.codeanalysis.visualbasic",
        "@nuget_packages//:microsoft.codeanalysis.common",
        "@nuget_packages//:microsoft.codeanalysis.analyzers",
        "@nuget_packages//:system.codedom",
        "@nuget_packages//:system.configuration.configurationmanager",
        "@nuget_packages//:mono.cecil",
    ],
    defines = ["NET"],
    allow_unsafe_blocks = True,
)

csharp_binary(
    name = "Renode",
    srcs = [
      "src/Renode/Backends/Terminals/UartPtyTerminal.cs",
      "src/Renode/Connectors/GPIOConnector.cs",
      "src/Renode/EmulationEnvironment/EmulationEnvironment.cs",
      "src/Renode/Integrations/ArduinoLoader.cs",
      "src/Renode/Integrations/AsciinemaRecorder.cs",
      "src/Renode/Network/NetworkServer/IServerModule.cs",
      "src/Renode/Network/NetworkServer/Modules/TftpServerModule.cs",
      "src/Renode/Network/NetworkServer/NetworkServer.cs",
      "src/Renode/Network/RangeLossMediumFunction.cs",
      "src/Renode/Network/RangeMediumFunction.cs",
      "src/Renode/PlatformDescription/ConversionResult.cs",
      "src/Renode/PlatformDescription/ConversionResultType.cs",
      "src/Renode/PlatformDescription/CreationDriver.cs",
      "src/Renode/PlatformDescription/DeclarationPlace.cs",
      "src/Renode/PlatformDescription/FakeInitHandler.cs",
      "src/Renode/PlatformDescription/IInitHandler.cs",
      "src/Renode/PlatformDescription/IUsingResolver.cs",
      "src/Renode/PlatformDescription/ParsingError.cs",
      "src/Renode/PlatformDescription/ParsingException.cs",
      "src/Renode/PlatformDescription/PreLexer.cs",
      "src/Renode/PlatformDescription/SerializationProvider.cs",
      "src/Renode/PlatformDescription/Syntax/Attribute.cs",
      "src/Renode/PlatformDescription/Syntax/BoolValue.cs",
      "src/Renode/PlatformDescription/Syntax/ConstructorOrPropertyAttribute.cs",
      "src/Renode/PlatformDescription/Syntax/Description.cs",
      "src/Renode/PlatformDescription/Syntax/EmptyValue.cs",
      "src/Renode/PlatformDescription/Syntax/Entry.cs",
      "src/Renode/PlatformDescription/Syntax/EnumValue.cs",
      "src/Renode/PlatformDescription/Syntax/Grammar.cs",
      "src/Renode/PlatformDescription/Syntax/IInitable.cs",
      "src/Renode/PlatformDescription/Syntax/InitAttribute.cs",
      "src/Renode/PlatformDescription/Syntax/IPrefixable.cs",
      "src/Renode/PlatformDescription/Syntax/IrqAttribute.cs",
      "src/Renode/PlatformDescription/Syntax/IrqDestinations.cs",
      "src/Renode/PlatformDescription/Syntax/IrqEnd.cs",
      "src/Renode/PlatformDescription/Syntax/IrqReceiver.cs",
      "src/Renode/PlatformDescription/Syntax/ISimplestValue.cs",
      "src/Renode/PlatformDescription/Syntax/IVisitable.cs",
      "src/Renode/PlatformDescription/Syntax/IWithPosition.cs",
      "src/Renode/PlatformDescription/Syntax/NumericalValue.cs",
      "src/Renode/PlatformDescription/Syntax/ObjectValue.cs",
      "src/Renode/PlatformDescription/Syntax/RangeValue.cs",
      "src/Renode/PlatformDescription/Syntax/ReferenceValue.cs",
      "src/Renode/PlatformDescription/Syntax/RegistrationInfo.cs",
      "src/Renode/PlatformDescription/Syntax/SingleOrMultiIrqEnd.cs",
      "src/Renode/PlatformDescription/Syntax/StringValue.cs",
      "src/Renode/PlatformDescription/Syntax/StringWithPosition.cs",
      "src/Renode/PlatformDescription/Syntax/SyntaxTreeHelpers.cs",
      "src/Renode/PlatformDescription/Syntax/UsingEntry.cs",
      "src/Renode/PlatformDescription/Syntax/Value.cs",
      "src/Renode/PlatformDescription/UserInterface/MonitorInitHandler.cs",
      "src/Renode/PlatformDescription/UserInterface/PlatformDescriptionMachineExtensions.cs",
      "src/Renode/PlatformDescription/Variable.cs",
      "src/Renode/PlatformDescription/VariableStore.cs",
      "src/Renode/Program.cs",
      "src/Renode/RobotFrameworkEngine/CpuKeywords.cs",
      "src/Renode/RobotFrameworkEngine/HelperExtensions.cs",
      "src/Renode/RobotFrameworkEngine/HotSpotAction.cs",
      "src/Renode/RobotFrameworkEngine/HttpServer.cs",
      "src/Renode/RobotFrameworkEngine/IRobotFrameworkKeywordProvider.cs",
      "src/Renode/RobotFrameworkEngine/Keyword.cs",
      "src/Renode/RobotFrameworkEngine/KeywordException.cs",
      "src/Renode/RobotFrameworkEngine/KeywordManager.cs",
      "src/Renode/RobotFrameworkEngine/LedKeywords.cs",
      "src/Renode/RobotFrameworkEngine/LogTester.cs",
      "src/Renode/RobotFrameworkEngine/NetworkInterfaceKeywords.cs",
      "src/Renode/RobotFrameworkEngine/Recorder.cs",
      "src/Renode/RobotFrameworkEngine/RenodeKeywords.cs",
      "src/Renode/RobotFrameworkEngine/RobotFrameworkEngine.cs",
      "src/Renode/RobotFrameworkEngine/RobotFrameworkKeywordAttribute.cs",
      "src/Renode/RobotFrameworkEngine/TestersProvider.cs",
      "src/Renode/RobotFrameworkEngine/UartKeywords.cs",
      "src/Renode/RobotFrameworkEngine/XmlRpcServer.cs",
      "src/Renode/UI/LogoRow.cs",
      "src/Renode/UI/TerminalActions.cs",
      "src/Renode/UI/TerminalIOSource.cs",
      "src/Renode/UI/TerminalWidget.cs",
      "src/Renode/UI/TermsharpProvider.cs",
    ],
    internals_visible_to = ["//visibility:public"],
    target_frameworks = ["net6.0"],
    targeting_packs = [
        "@rules_dotnet_nuget_packages//microsoft.netcore.app.ref",
    ],
    deps = [
        "@RenodeInfrastructure//:Emulator",
        "@RenodeInfrastructure//:Extensions",
        "@RenodeInfrastructure//:Renode-peripherals",
        "@RenodeInfrastructure//:cores-arm",
        "@RenodeInfrastructure//:cores-arm-m",
        "@RenodeInfrastructure//:cores-arm64",
        "@RenodeInfrastructure//:cores-i386",
        "@RenodeInfrastructure//:cores-ppc",
        "@RenodeInfrastructure//:cores-ppc64",
        "@RenodeInfrastructure//:cores-riscv",
        "@RenodeInfrastructure//:cores-riscv64",
        "@RenodeInfrastructure//:cores-sparc",
        "@RenodeInfrastructure//:cores-xtensa",
        "@RenodeInfrastructure//:UI",
        "@RenodeInfrastructure//:AdvancedLoggerViewerPlugin",
        "@RenodeInfrastructure//:SampleCommandPlugin",
        "@RenodeInfrastructure//:TracePlugin",
        "//toolchain_renode:VerilatorPlugin",
        "//toolchain_renode:WiresharkPlugin",
        "@Migrant//:Migrant",
        "@ELFSharp//:ELFSharp",
        "@PacketDotNet//:PacketDotNet",
        "@CxxDemangler//:CxxDemangler",
        "@AntShell//:AntShell",
        "@Xwt//:Xwt",
        "@BigGustave//:BigGustave",
        "@Xwt//:XwtGtk",
        "@termsharp//:TermSharp",
        "@libtftp//:libtftp",
        "@OptionsParser//:OptionsParser",
        "@FdtSharp//:FdtSharp",
        "@crypto//:crypto",
        "//toolchain_renode/resources:MicrosoftScripting",
        "//toolchain_renode/resources:MonoLinqExpressions",
        "//toolchain_renode/resources:MonoTextTemplating",
        "//toolchain_renode/resources:Dynamitey",
        "//toolchain_renode/resources:Sprache",
        "//toolchain_renode/resources:CookComputingXmlRpcV2",
        "//toolchain_renode/resources:MicrosoftDynamic",
        "@nuget_packages//:system.drawing.common",
        "@nuget_packages//:gtksharp",
        "@nuget_packages//:atksharp",
        "@nuget_packages//:glibsharp",
        "@nuget_packages//:cairosharp",
        "@nuget_packages//:gdksharp",
        "@nuget_packages//:giosharp",
        "@nuget_packages//:pangosharp",
        "@nuget_packages//:mono.posix.netstandard",
        "@nuget_packages//:microsoft.codeanalysis.csharp",
        "@nuget_packages//:microsoft.codeanalysis.visualbasic",
        "@nuget_packages//:microsoft.codeanalysis.common",
        "@nuget_packages//:microsoft.codeanalysis.analyzers",
        "@nuget_packages//:system.codedom",
        "@nuget_packages//:system.configuration.configurationmanager",
        "@nuget_packages//:mono.cecil",
        "@nuget_packages//:ironpython",
    ],
    defines = ["NET"],
    out = "Renode",
    winexe = True,
)
publish_binary(
    name = "publish_renode",
    binary = ":Renode",
    runtime_packs = select({
        "@rules_dotnet//dotnet:rid_linux-x64": ["@rules_dotnet_dev_nuget_packages//microsoft.netcore.app.runtime.linux-x64"],
        "@rules_dotnet//dotnet:rid_osx-x64": ["@rules_dotnet_dev_nuget_packages//microsoft.netcore.app.runtime.osx-x64"],
        "@rules_dotnet//dotnet:rid_win-x64": ["@rules_dotnet_dev_nuget_packages//microsoft.netcore.app.runtime.win-x64"],
    }),
    self_contained = True,
    target_framework = "net6.0",
)
